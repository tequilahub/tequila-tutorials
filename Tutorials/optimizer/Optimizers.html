<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sumner Alperin">
<meta name="author" content="Adapted by Thuy Truong">
<meta name="dcterms.date" content="2024-07-05">

<title>Tequila Tutorials - Optimizer</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.ico" rel="icon">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-V7DRP5E70N"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-V7DRP5E70N', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"express",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  });
});
</script> 
  

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Tequila Tutorials - Optimizer">
<meta property="og:description" content="">
<meta property="og:image" content="https://github.com/tequilahub/tequila-tutorials/Tutorials/optimizer/optimizer.png">
<meta property="og:site-name" content="Tequila Tutorials">
<meta property="og:image:height" content="1792">
<meta property="og:image:width" content="2486">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../tequila_logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Tequila Tutorials</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../research.html" rel="" target="">
 <span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials.html" rel="" target="">
 <span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../FAQ/FAQ.html" rel="" target="">
 <span class="menu-text">FAQ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Contribution/Contribution.html" rel="" target="">
 <span class="menu-text">Contribution</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../docs/sphinx/index.html" rel="" target="">
 <span class="menu-text">Docs</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Optimizer</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">code</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Authors</div>
      <div class="quarto-title-meta-contents">
               <p>Sumner Alperin </p>
               <p>Adapted by Thuy Truong </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 5, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#local-optimizers" id="toc-local-optimizers" class="nav-link" data-scroll-target="#local-optimizers">Local Optimizers</a>
  <ul class="collapse">
  <li><a href="#the-gd-optimizer" id="toc-the-gd-optimizer" class="nav-link" data-scroll-target="#the-gd-optimizer">The GD Optimizer</a></li>
  <li><a href="#the-scipy-optimizer" id="toc-the-scipy-optimizer" class="nav-link" data-scroll-target="#the-scipy-optimizer">The SciPy Optimizer</a></li>
  </ul></li>
  <li><a href="#numerical-and-customized-gradients" id="toc-numerical-and-customized-gradients" class="nav-link" data-scroll-target="#numerical-and-customized-gradients">Numerical and Customized Gradients</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/tequilahub/tequila/blob/main/Tutorials/optimizer/Optimizers.ipynb" class="toc-action">View source</a></p><p><a href="https://github.com/tequilahub/tequila/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>Explore the two different optimizers available through Tequila interfaces:<br>
A native gradient descent (GD) optimizer, as well as interfaces for SciPy optimizers.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:11.971055Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:11.969183Z&quot;}" data-execution_count="51">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tequila <span class="im">as</span> tq</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="overview" class="level1">
<h1>Overview</h1>
<p><strong>How to optimize an <code>Objective</code>:</strong></p>
<p>In <code>Tequila</code>, optimizers are accessed in several ways. They may be instantiated directly as objects and then called, or they can be accessed through the <code>tq.minimize</code>. Both methods require an <code>Objective</code>as an obligatory argument. Additionally, <code>tq.minimize</code>needs a <code>method</code>, which must be a string. The call methods of the GD and <code>SciPy</code> optimizers accept this key as well.</p>
<p>You can include the usual compilation kwargs for quantum simulation in <code>Tequila</code>as keywords to any optimization call.</p>
<ul>
<li><code>backend</code>, a string indicating which quantum simulator to use</li>
<li><code>samples</code>, an integer indicating the number of shots of the circuit to measure (None means full wavefunction simulation)</li>
<li><code>device</code>, generally a string indicating which (real or emulated) quantum computer to sample from (requires <code>samples</code> be specified)</li>
<li><code>noise</code>, the NoiseModel object to apply to the simulated circuits (see the tutorial on noise).</li>
</ul>
<p>Additional keywords you might use are:</p>
<ul>
<li><code>variables</code>, a <code>list</code> of the <code>Variables</code> you want to optimize (default is all).</li>
<li><code>initial_values</code>, which gives a start point to optimization. If you supply arguments to <code>variables</code>, you also need to supply arguments to <code>initial_values</code> so that all non-optimized parameters have a value to use. The default is random initialization (not recomended)</li>
<li><code>gradient</code>, which specifies which type of gradient will be used :
<ul>
<li>analytical gradients (Default): <code>gradient=None</code></li>
<li>numerical gradients: <code>gradient={'method':'2-point', "stepsize":1.e-4}</code></li>
<li>custom gradient objectives: <code>gradient={tq.Variable:tq.Objective}</code></li>
<li>module specific gradients: <code>gradient="2-point"</code> (to use for example <code>SciPy</code> finite difference stencils)</li>
</ul></li>
<li><code>silent</code>, silence outputs</li>
</ul>
<p>Some of the optimizers take more, or different, keywords from the others, so check the documentation for each one. In case the optimizer has some degree of verbosity (currently, they all do), you can deactivate this with <code>silent=True</code>.</p>
<p>The following optimization methods are available on your system in <code>Tequila</code>:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:12.061485Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:12.059640Z&quot;}" data-execution_count="52">
<div class="sourceCode cell-code" id="annotated-cell-2"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="1">1</button><span id="annotated-cell-2-1" class="code-annotation-target"><a href="#annotated-cell-2-1" aria-hidden="true" tabindex="-1"></a>tq.optimizers.show_available_optimizers()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-2" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-2">Get a list of all available optimizers</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>available methods for optimizer modules found on your system:
method               | optimizer module
--------------------------
NELDER-MEAD          | scipy
COBYLA               | scipy
POWELL               | scipy
SLSQP                | scipy
L-BFGS-B             | scipy
BFGS                 | scipy
CG                   | scipy
TNC                  | scipy
TRUST-KRYLOV         | scipy
NEWTON-CG            | scipy
DOGLEG               | scipy
TRUST-NCG            | scipy
TRUST-EXACT          | scipy
TRUST-CONSTR         | scipy
adam                 | gd
adagrad              | gd
adamax               | gd
nadam                | gd
sgd                  | gd
momentum             | gd
nesterov             | gd
rmsprop              | gd
rmsprop-nesterov     | gd
spsa                 | gd
gpyopt-lbfgs         | gpyopt
gpyopt-direct        | gpyopt
gpyopt-cma           | gpyopt
Supported optimizer modules:  ['scipy', 'gpyopt', 'gd']
Installed optimizer modules:  ['scipy', 'gd', 'gpyopt']</code></pre>
</div>
</div>
<p>We will use two different <code>Objectives</code> for optimization in this tutorial.<br>
The first <code>Objective</code> <span class="math inline">\(O_1\)</span> computes a two qubit expectation value using the tractable but non-trivial hamiltonian <span class="math inline">\([Y(0)+Qm(0)]\otimes X(1)\)</span>, where <span class="math inline">\(Qm=\frac{1}{2} (I - Z)\)</span> is the projector onto the <span class="math inline">\(\Ket{1}\)</span> state.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:12.067424Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:12.063005Z&quot;}" data-execution_count="53">
<div class="sourceCode cell-code" id="annotated-cell-3"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="1">1</button><span id="annotated-cell-3-1" class="code-annotation-target"><a href="#annotated-cell-3-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> tq.Variable(name<span class="op">=</span><span class="st">"a"</span>)<span class="op">*</span>tq.numpy.pi</span>
<span id="annotated-cell-3-2"><a href="#annotated-cell-3-2" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> tq.Variable(name<span class="op">=</span><span class="st">"b"</span>)<span class="op">*</span>tq.numpy.pi</span>
<span id="annotated-cell-3-3"><a href="#annotated-cell-3-3" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> tq.Variable(name<span class="op">=</span><span class="st">"c"</span>)<span class="op">*</span>tq.numpy.pi</span>
<span id="annotated-cell-3-4"><a href="#annotated-cell-3-4" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> tq.Variable(name<span class="op">=</span><span class="st">'d'</span>)<span class="op">*</span>tq.numpy.pi</span>
<span id="annotated-cell-3-5"><a href="#annotated-cell-3-5" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="2">2</button><span id="annotated-cell-3-6" class="code-annotation-target"><a href="#annotated-cell-3-6" aria-hidden="true" tabindex="-1"></a>U1 <span class="op">=</span> tq.gates.H(target<span class="op">=</span>[<span class="dv">0</span>])</span>
<span id="annotated-cell-3-7"><a href="#annotated-cell-3-7" aria-hidden="true" tabindex="-1"></a>U1 <span class="op">+=</span> tq.gates.H(target<span class="op">=</span><span class="dv">1</span>)</span>
<span id="annotated-cell-3-8"><a href="#annotated-cell-3-8" aria-hidden="true" tabindex="-1"></a>U1 <span class="op">+=</span> tq.gates.Ry(target<span class="op">=</span><span class="dv">0</span>, angle<span class="op">=</span>a)</span>
<span id="annotated-cell-3-9"><a href="#annotated-cell-3-9" aria-hidden="true" tabindex="-1"></a>U1 <span class="op">+=</span> tq.gates.Rz(target<span class="op">=</span><span class="dv">1</span>, angle<span class="op">=</span>b)</span>
<span id="annotated-cell-3-10"><a href="#annotated-cell-3-10" aria-hidden="true" tabindex="-1"></a>U1 <span class="op">+=</span> tq.gates.Z(target<span class="op">=</span><span class="dv">1</span>,control<span class="op">=</span><span class="dv">0</span>)</span>
<span id="annotated-cell-3-11"><a href="#annotated-cell-3-11" aria-hidden="true" tabindex="-1"></a>U1 <span class="op">+=</span> tq.gates.Rx(target<span class="op">=</span><span class="dv">0</span>, angle<span class="op">=</span>c)</span>
<span id="annotated-cell-3-12"><a href="#annotated-cell-3-12" aria-hidden="true" tabindex="-1"></a>U1 <span class="op">+=</span> tq.gates.Rx(target<span class="op">=</span><span class="dv">1</span>,angle<span class="op">=</span>d)</span>
<span id="annotated-cell-3-13"><a href="#annotated-cell-3-13" aria-hidden="true" tabindex="-1"></a>U1 <span class="op">+=</span> tq.gates.Z(target<span class="op">=</span><span class="dv">1</span>,control<span class="op">=</span><span class="dv">0</span>)</span>
<span id="annotated-cell-3-14"><a href="#annotated-cell-3-14" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="3">3</button><span id="annotated-cell-3-15" class="code-annotation-target"><a href="#annotated-cell-3-15" aria-hidden="true" tabindex="-1"></a>H1<span class="op">=</span>(tq.paulis.Y(<span class="dv">0</span>)<span class="op">+</span>tq.paulis.Qm(<span class="dv">0</span>))<span class="op">*</span>tq.paulis.X(<span class="dv">1</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="4">4</button><span id="annotated-cell-3-16" class="code-annotation-target"><a href="#annotated-cell-3-16" aria-hidden="true" tabindex="-1"></a>O1<span class="op">=</span>tq.ExpectationValue(U<span class="op">=</span>U1,H<span class="op">=</span>H1)</span>
<span id="annotated-cell-3-17"><a href="#annotated-cell-3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-18"><a href="#annotated-cell-3-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'We will optimize the following objective: </span><span class="ch">\n</span><span class="st">'</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-3" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1,2,3,4" data-code-annotation="1" data-code-cell="annotated-cell-3">Optimizing the circuit in terms of pi makes the result of the optimization easier to interpret</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="6,7,8,9,10,11,12,13" data-code-annotation="2" data-code-cell="annotated-cell-3">Create a 2-qubit quantum circuit for the <code>Objective</code> <span class="math inline">\(O_1\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="15" data-code-annotation="3" data-code-cell="annotated-cell-3">Define the Hamiltonian for <span class="math inline">\(O_1\)</span> to optimize over</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="16" data-code-annotation="4" data-code-cell="annotated-cell-3">Define the expectation value of the Hamiltonian after applying the quantum circuit</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>We will optimize the following objective: 
</code></pre>
</div>
</div>
<p><img src="O1.png" class="img-fluid" style="width:60.0%"></p>
<p>Our second <code>Objective</code> <span class="math inline">\(O_2\)</span> will measure a 3-qubit circuit with respect to the Hamiltonian <span class="math inline">\(Y(0)\otimes X(1) \otimes Y(2)\)</span>.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:12.072192Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:12.068242Z&quot;}" data-execution_count="54">
<div class="sourceCode cell-code" id="annotated-cell-4"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="1">1</button><span id="annotated-cell-4-1" class="code-annotation-target"><a href="#annotated-cell-4-1" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="2">2</button><span id="annotated-cell-4-2" class="code-annotation-target"><a href="#annotated-cell-4-2" aria-hidden="true" tabindex="-1"></a>U2 <span class="op">=</span> tq.gates.Ry(tq.numpy.pi<span class="op">/</span><span class="dv">2</span>,<span class="dv">0</span>) <span class="op">+</span>tq.gates.Ry(tq.numpy.pi<span class="op">/</span><span class="dv">3</span>,<span class="dv">1</span>)<span class="op">+</span>tq.gates.Ry(tq.numpy.pi<span class="op">/</span><span class="dv">4</span>,<span class="dv">2</span>)</span>
<span id="annotated-cell-4-3"><a href="#annotated-cell-4-3" aria-hidden="true" tabindex="-1"></a>U2 <span class="op">+=</span> tq.gates.Rz(<span class="st">'a'</span>,<span class="dv">0</span>)<span class="op">+</span>tq.gates.Rz(<span class="st">'b'</span>,<span class="dv">1</span>)</span>
<span id="annotated-cell-4-4"><a href="#annotated-cell-4-4" aria-hidden="true" tabindex="-1"></a>U2 <span class="op">+=</span> tq.gates.CNOT(control<span class="op">=</span><span class="dv">0</span>,target<span class="op">=</span><span class="dv">1</span>)<span class="op">+</span>tq.gates.CNOT(control<span class="op">=</span><span class="dv">1</span>,target<span class="op">=</span><span class="dv">2</span>)</span>
<span id="annotated-cell-4-5"><a href="#annotated-cell-4-5" aria-hidden="true" tabindex="-1"></a>U2 <span class="op">+=</span> tq.gates.Ry(<span class="st">'c'</span>,<span class="dv">1</span>) <span class="op">+</span>tq.gates.Rx(<span class="st">'d'</span>,<span class="dv">2</span>)</span>
<span id="annotated-cell-4-6"><a href="#annotated-cell-4-6" aria-hidden="true" tabindex="-1"></a>U2 <span class="op">+=</span> tq.gates.CNOT(control<span class="op">=</span><span class="dv">0</span>,target<span class="op">=</span><span class="dv">1</span>)<span class="op">+</span>tq.gates.CNOT(control<span class="op">=</span><span class="dv">1</span>,target<span class="op">=</span><span class="dv">2</span>)</span>
<span id="annotated-cell-4-7"><a href="#annotated-cell-4-7" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="3">3</button><span id="annotated-cell-4-8" class="code-annotation-target"><a href="#annotated-cell-4-8" aria-hidden="true" tabindex="-1"></a>H2 <span class="op">=</span> tq.paulis.Y(<span class="dv">0</span>)<span class="op">*</span>tq.paulis.X(<span class="dv">1</span>)<span class="op">*</span>tq.paulis.Y(<span class="dv">2</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="4">4</button><span id="annotated-cell-4-9" class="code-annotation-target"><a href="#annotated-cell-4-9" aria-hidden="true" tabindex="-1"></a>O2 <span class="op">=</span> tq.ExpectationValue(H<span class="op">=</span>H2, U<span class="op">=</span>U2)</span>
<span id="annotated-cell-4-10"><a href="#annotated-cell-4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-11"><a href="#annotated-cell-4-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'We will optimize the following objective: </span><span class="ch">\n</span><span class="st">'</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-4" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-4">This time, we don’t optimize the circuit in terms of pi</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2,3,4,5,6" data-code-annotation="2" data-code-cell="annotated-cell-4">Create a 3-qubit quantum circuit for the <code>Objective</code> <span class="math inline">\(O_2\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="8" data-code-annotation="3" data-code-cell="annotated-cell-4">Define the Hamiltonian for <span class="math inline">\(O_2\)</span> to optimize over</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="9" data-code-annotation="4" data-code-cell="annotated-cell-4">Define the expectation value of the Hamiltonian after applying the quantum circuit</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>We will optimize the following objective: 
</code></pre>
</div>
</div>
<p><img src="O2.png" class="img-fluid" style="width:80.0%"></p>
</section>
<section id="local-optimizers" class="level1">
<h1>Local Optimizers</h1>
<p>We will begin this tutorial by focusing on local optimizers. Local optimization refers to any optimization schema where the suggested parameters at step <span class="math inline">\(t\)</span> are always a transformation of the parameters suggested at step <span class="math inline">\(t-1\)</span>. This includes a large number of the standard optimization techniques in use today, like gradient descent.</p>
<p><code>Tequila</code> provides two local optimizers: a native gradient descent optimizer, implementing several popular gradient descent algorithms used in classical machine learning, as well as a plugin for the <code>SciPy</code> package (which is installed alongside <code>Tequila</code>), which allows the use of various gradient-free, gradient-based, and Hessian-based optimization methods.</p>
<section id="the-gd-optimizer" class="level2">
<h2 class="anchored" data-anchor-id="the-gd-optimizer">The GD Optimizer</h2>
<p>We will start this tutorial by looking at the GD optimizer. Here is an overview over the available optimization methods.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:12.074697Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:12.072932Z&quot;}" data-execution_count="55">
<div class="sourceCode cell-code" id="annotated-cell-5"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="1">1</button><span id="annotated-cell-5-1" class="code-annotation-target"><a href="#annotated-cell-5-1" aria-hidden="true" tabindex="-1"></a>tq.show_available_optimizers(module<span class="op">=</span><span class="st">"gd"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-5" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-5">Get a list of all available optimization methods for the GD optimizer</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>available methods for optimizer module gd
method               | optimizer module
--------------------------
adam                 | gd
adagrad              | gd
adamax               | gd
nadam                | gd
sgd                  | gd
momentum             | gd
nesterov             | gd
rmsprop              | gd
rmsprop-nesterov     | gd
spsa                 | gd</code></pre>
</div>
</div>
<p>A variety of methods are available for optimization. Here, ‘sgd’ refers to the standard gradient descent algorithm, without momentum. Like all Tequila optimizers, the GD optimizer has a <code>minimize</code> function and most of the arguments are the same. However, there is one important difference: the GD optimizer takes a learning rate (lr). This parameter mediates step size in all of the GD optimizer methods; It is a positive float which scales the step in the direction of the gradient.</p>
<p>We will now optimize <span class="math inline">\(O_1\)</span>, our two-qubit expectation value, starting with angles equivalent to <span class="math inline">\(\frac{1}{4}\pi\)</span> for all four variables, and optimizing via the <a href="https://towardsdatascience.com/_adam-latest-trends-in-deep-learning-optimization-6be9a291375c">‘Adam’</a> method.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:12.143971Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:12.075479Z&quot;}" data-execution_count="56">
<div class="sourceCode cell-code" id="annotated-cell-6"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="1">1</button><span id="annotated-cell-6-1" class="code-annotation-target"><a href="#annotated-cell-6-1" aria-hidden="true" tabindex="-1"></a>init<span class="op">=</span>{<span class="st">'a'</span>:<span class="fl">0.25</span>,<span class="st">'b'</span>:<span class="fl">0.25</span>,<span class="st">'c'</span>:<span class="fl">0.25</span>,<span class="st">'d'</span>:<span class="fl">0.25</span>}</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="2">2</button><span id="annotated-cell-6-2" class="code-annotation-target"><a href="#annotated-cell-6-2" aria-hidden="true" tabindex="-1"></a>lr<span class="op">=</span><span class="fl">0.1</span></span>
<span id="annotated-cell-6-3"><a href="#annotated-cell-6-3" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="3">3</button><span id="annotated-cell-6-4" class="code-annotation-target"><a href="#annotated-cell-6-4" aria-hidden="true" tabindex="-1"></a>adam_result<span class="op">=</span>tq.minimize(objective<span class="op">=</span>O1,</span>
<span id="annotated-cell-6-5"><a href="#annotated-cell-6-5" aria-hidden="true" tabindex="-1"></a>                        lr<span class="op">=</span>lr,</span>
<span id="annotated-cell-6-6"><a href="#annotated-cell-6-6" aria-hidden="true" tabindex="-1"></a>                        method<span class="op">=</span><span class="st">'adam'</span>,</span>
<span id="annotated-cell-6-7"><a href="#annotated-cell-6-7" aria-hidden="true" tabindex="-1"></a>                        maxiter<span class="op">=</span><span class="dv">80</span>,</span>
<span id="annotated-cell-6-8"><a href="#annotated-cell-6-8" aria-hidden="true" tabindex="-1"></a>                        initial_values<span class="op">=</span>init,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="4">4</button><span id="annotated-cell-6-9" class="code-annotation-target"><a href="#annotated-cell-6-9" aria-hidden="true" tabindex="-1"></a>                        silent<span class="op">=</span><span class="va">True</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-6" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-6">Initialize all four variables to <span class="math inline">\(\frac{1}{4}\pi\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2" data-code-annotation="2" data-code-cell="annotated-cell-6">Set the learning rate to 0.1</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="4,5,6,7,8" data-code-annotation="3" data-code-cell="annotated-cell-6">Optimize the objective <span class="math inline">\(O_1\)</span> using the <code>Adam</code> method with learning rate 0.1 and maximal iterations 80</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="9" data-code-annotation="4" data-code-cell="annotated-cell-6">Set silent=True to suppress output</span>
</dd>
</dl>
</div>
</div>
<p>The plots below show the trajectory of both the value of the objective and the values of the angles as a function of time.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:12.276677Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:12.144993Z&quot;}" data-execution_count="57">
<div class="sourceCode cell-code" id="annotated-cell-7"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="1">1</button><span id="annotated-cell-7-1" class="code-annotation-target"><a href="#annotated-cell-7-1" aria-hidden="true" tabindex="-1"></a>adam_result.history.plot(<span class="st">'energies'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="2">2</button><span id="annotated-cell-7-2" class="code-annotation-target"><a href="#annotated-cell-7-2" aria-hidden="true" tabindex="-1"></a>adam_result.history.plot(<span class="st">'angles'</span>)</span>
<span id="annotated-cell-7-3"><a href="#annotated-cell-7-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'best energy: '</span>,adam_result.energy)</span>
<span id="annotated-cell-7-4"><a href="#annotated-cell-7-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'optimal angles: '</span>,adam_result.angles)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-7" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-7">Plot energy from Adam optimization</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2" data-code-annotation="2" data-code-cell="annotated-cell-7">Plot angles from Adam optimization</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-8-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-8-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>best energy:  -1.6179942179567814
optimal angles:  a : 0.14749685873977889
b : 1.0037045157384548
c : -0.0020942234687567523
d : -0.4982090391144128
</code></pre>
</div>
</div>
<p><strong>We see that, apart from a few hiccups, all the angles converge to optimimal values.</strong></p>
<p><strong>Let’s repeat what we did above, but with a few other methods! Here’s RMSprop:</strong></p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:12.464087Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:12.277946Z&quot;}" data-execution_count="58">
<div class="sourceCode cell-code" id="annotated-cell-8"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="1">1</button><span id="annotated-cell-8-1" class="code-annotation-target"><a href="#annotated-cell-8-1" aria-hidden="true" tabindex="-1"></a>init<span class="op">=</span>{<span class="st">'a'</span>:<span class="fl">0.25</span>,<span class="st">'b'</span>:<span class="fl">0.25</span>,<span class="st">'c'</span>:<span class="fl">0.25</span>,<span class="st">'d'</span>:<span class="fl">0.25</span>}</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="2">2</button><span id="annotated-cell-8-2" class="code-annotation-target"><a href="#annotated-cell-8-2" aria-hidden="true" tabindex="-1"></a>lr<span class="op">=</span><span class="fl">0.01</span></span>
<span id="annotated-cell-8-3"><a href="#annotated-cell-8-3" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="3">3</button><span id="annotated-cell-8-4" class="code-annotation-target"><a href="#annotated-cell-8-4" aria-hidden="true" tabindex="-1"></a>rms_result<span class="op">=</span>tq.minimize(objective<span class="op">=</span>O1,</span>
<span id="annotated-cell-8-5"><a href="#annotated-cell-8-5" aria-hidden="true" tabindex="-1"></a>                       lr<span class="op">=</span>lr,</span>
<span id="annotated-cell-8-6"><a href="#annotated-cell-8-6" aria-hidden="true" tabindex="-1"></a>                       method<span class="op">=</span><span class="st">'rmsprop'</span>,</span>
<span id="annotated-cell-8-7"><a href="#annotated-cell-8-7" aria-hidden="true" tabindex="-1"></a>                       maxiter<span class="op">=</span><span class="dv">80</span>,</span>
<span id="annotated-cell-8-8"><a href="#annotated-cell-8-8" aria-hidden="true" tabindex="-1"></a>                       initial_values<span class="op">=</span>init,</span>
<span id="annotated-cell-8-9"><a href="#annotated-cell-8-9" aria-hidden="true" tabindex="-1"></a>                       silent<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-8-10"><a href="#annotated-cell-8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-11"><a href="#annotated-cell-8-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSprop optimization results:'</span>)</span>
<span id="annotated-cell-8-12"><a href="#annotated-cell-8-12" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="4">4</button><span id="annotated-cell-8-13" class="code-annotation-target"><a href="#annotated-cell-8-13" aria-hidden="true" tabindex="-1"></a>rms_result.history.plot(<span class="st">'energies'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="5">5</button><span id="annotated-cell-8-14" class="code-annotation-target"><a href="#annotated-cell-8-14" aria-hidden="true" tabindex="-1"></a>rms_result.history.plot(<span class="st">'angles'</span>)</span>
<span id="annotated-cell-8-15"><a href="#annotated-cell-8-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'best energy: '</span>,rms_result.energy)</span>
<span id="annotated-cell-8-16"><a href="#annotated-cell-8-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'optimal angles: '</span>,rms_result.angles)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-8" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-8">Initialize all four variables to <span class="math inline">\(\frac{1}{4}\pi\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2" data-code-annotation="2" data-code-cell="annotated-cell-8">Set the learning rate to 0.01</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="4,5,6,7,8,9" data-code-annotation="3" data-code-cell="annotated-cell-8">Optimize the objective <span class="math inline">\(O_1\)</span> using the <code>RMSprop</code> method with learning rate 0.01 and maximal iterations 80</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="13" data-code-annotation="4" data-code-cell="annotated-cell-8">Plot energy from RMSprop optimization</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="5">5</dt>
<dd>
<span data-code-lines="14" data-code-annotation="5" data-code-cell="annotated-cell-8">Plot angles from RMSprop optimization</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>RMSprop optimization results:
best energy:  -1.6180339887498942
optimal angles:  a : 0.14758361765043307
b : 0.9999999875406629
c : 1.498301743024053e-08
d : -0.5
</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-9-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-9-output-3.png" class="img-fluid"></p>
</div>
</div>
<p><strong>… And now let’s take a look at Momentum:</strong></p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:12.723674Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:12.466517Z&quot;}" data-execution_count="59">
<div class="sourceCode cell-code" id="annotated-cell-9"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="1">1</button><span id="annotated-cell-9-1" class="code-annotation-target"><a href="#annotated-cell-9-1" aria-hidden="true" tabindex="-1"></a>init<span class="op">=</span>{<span class="st">'a'</span>:<span class="fl">0.25</span>,<span class="st">'b'</span>:<span class="fl">0.25</span>,<span class="st">'c'</span>:<span class="fl">0.25</span>,<span class="st">'d'</span>:<span class="fl">0.25</span>}</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="2">2</button><span id="annotated-cell-9-2" class="code-annotation-target"><a href="#annotated-cell-9-2" aria-hidden="true" tabindex="-1"></a>lr<span class="op">=</span><span class="fl">0.1</span></span>
<span id="annotated-cell-9-3"><a href="#annotated-cell-9-3" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="3">3</button><span id="annotated-cell-9-4" class="code-annotation-target"><a href="#annotated-cell-9-4" aria-hidden="true" tabindex="-1"></a>mom_result<span class="op">=</span>tq.minimize(objective<span class="op">=</span>O1,</span>
<span id="annotated-cell-9-5"><a href="#annotated-cell-9-5" aria-hidden="true" tabindex="-1"></a>                       lr<span class="op">=</span>lr,</span>
<span id="annotated-cell-9-6"><a href="#annotated-cell-9-6" aria-hidden="true" tabindex="-1"></a>                       method<span class="op">=</span><span class="st">'momentum'</span>,</span>
<span id="annotated-cell-9-7"><a href="#annotated-cell-9-7" aria-hidden="true" tabindex="-1"></a>                       maxiter<span class="op">=</span><span class="dv">80</span>,</span>
<span id="annotated-cell-9-8"><a href="#annotated-cell-9-8" aria-hidden="true" tabindex="-1"></a>                       initial_values<span class="op">=</span>init,</span>
<span id="annotated-cell-9-9"><a href="#annotated-cell-9-9" aria-hidden="true" tabindex="-1"></a>                       silent<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-9-10"><a href="#annotated-cell-9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-11"><a href="#annotated-cell-9-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'momentum optimization results:'</span>)                 </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="4">4</button><span id="annotated-cell-9-12" class="code-annotation-target"><a href="#annotated-cell-9-12" aria-hidden="true" tabindex="-1"></a>mom_result.history.plot(<span class="st">'energies'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="5">5</button><span id="annotated-cell-9-13" class="code-annotation-target"><a href="#annotated-cell-9-13" aria-hidden="true" tabindex="-1"></a>mom_result.history.plot(<span class="st">'angles'</span>)</span>
<span id="annotated-cell-9-14"><a href="#annotated-cell-9-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'best energy: '</span>,mom_result.energy)</span>
<span id="annotated-cell-9-15"><a href="#annotated-cell-9-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'optimal angles: '</span>,mom_result.angles)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-9" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-9">Initialize all four variables to <span class="math inline">\(\frac{1}{4}\pi\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2" data-code-annotation="2" data-code-cell="annotated-cell-9">Set the learning rate to 0.1</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="4,5,6,7,8,9" data-code-annotation="3" data-code-cell="annotated-cell-9">Optimize the objective <span class="math inline">\(O_1\)</span> using the <code>Momentum</code> method with learning rate 0.1 and maximal iterations 80</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="12" data-code-annotation="4" data-code-cell="annotated-cell-9">Plot energy from Momentum optimization</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="5">5</dt>
<dd>
<span data-code-lines="13" data-code-annotation="5" data-code-cell="annotated-cell-9">Plot angles from Momentum optimization</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>momentum optimization results:
best energy:  -1.617816413662847
optimal angles:  a : 0.15313030387151333
b : 0.9975386772455798
c : -0.0008949810647826415
d : -0.5018117058023004
</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-10-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-10-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>Note that when using the <a href="https://towardsdatascience.com/understanding-rmsprop-faster-neural-network-learning-62e116fcf29a">RMSprop</a> method, we reduced the learning rate from <span class="math inline">\(0.1\)</span> to <span class="math inline">\(0.01\)</span>. Different methods may be more or less sensitive to choices of initial learning rate. Feel free to revisit previous examples, and experiment with different learning rates, or initial parameters to gain insight into the sensitivity of different methods.</p>
<p><strong>Accelerated gradient descent to achieve numerical accuracy:</strong></p>
<p>One issue with gradient descent is that they are slow when it comes to converging to machine precision. As optimization nears an optimum, the gradient goes to zero, which means that each successive step is smaller and smaller, and convergence slows down. This is not really a problem in machine learning, where convergence to many digits is not needed, but it is an issue in chemistry.</p>
<p>The standard method used to converge quantum chemical calculations is an accelerated form of gradient descent alternatively called <code>Direct Inversion of the Iterative Subspace (DIIS)</code> or <code>Pulay mixing</code> (for its inventor Peter Pulay). DIIS extrapolates from the error on past function evaluation to where the error is zero using a subspace approach. It is closely related to other subpsace and Krylov methods, such as <code>GMRES</code>.</p>
<p>DIIS works best once we are pretty close to our solution. In this case, we start from a significantly better initial guess, and try to achieve a tolerance of <span class="math inline">\(\texttt{1e-10}\)</span> with just standard gradient descent.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:12.769088Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:12.724632Z&quot;}" data-execution_count="60">
<div class="sourceCode cell-code" id="annotated-cell-10"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="1">1</button><span id="annotated-cell-10-1" class="code-annotation-target"><a href="#annotated-cell-10-1" aria-hidden="true" tabindex="-1"></a>init<span class="op">=</span>{<span class="st">'a'</span>:<span class="fl">0.18</span>,<span class="st">'b'</span>:<span class="fl">0.8</span>,<span class="st">'c'</span>:<span class="op">-</span><span class="fl">0.1</span>,<span class="st">'d'</span>:<span class="op">-</span><span class="fl">0.4</span>}</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="2">2</button><span id="annotated-cell-10-2" class="code-annotation-target"><a href="#annotated-cell-10-2" aria-hidden="true" tabindex="-1"></a>lr<span class="op">=</span><span class="fl">0.1</span></span>
<span id="annotated-cell-10-3"><a href="#annotated-cell-10-3" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="3">3</button><span id="annotated-cell-10-4" class="code-annotation-target"><a href="#annotated-cell-10-4" aria-hidden="true" tabindex="-1"></a>no_diis_result<span class="op">=</span>tq.minimize(objective<span class="op">=</span>O1,</span>
<span id="annotated-cell-10-5"><a href="#annotated-cell-10-5" aria-hidden="true" tabindex="-1"></a>                           lr<span class="op">=</span>lr,</span>
<span id="annotated-cell-10-6"><a href="#annotated-cell-10-6" aria-hidden="true" tabindex="-1"></a>                           method<span class="op">=</span><span class="st">'sgd'</span>,</span>
<span id="annotated-cell-10-7"><a href="#annotated-cell-10-7" aria-hidden="true" tabindex="-1"></a>                           tol<span class="op">=</span><span class="fl">1e-10</span>,</span>
<span id="annotated-cell-10-8"><a href="#annotated-cell-10-8" aria-hidden="true" tabindex="-1"></a>                           maxiter<span class="op">=</span><span class="dv">80</span>,</span>
<span id="annotated-cell-10-9"><a href="#annotated-cell-10-9" aria-hidden="true" tabindex="-1"></a>                           initial_values<span class="op">=</span>init,</span>
<span id="annotated-cell-10-10"><a href="#annotated-cell-10-10" aria-hidden="true" tabindex="-1"></a>                           silent<span class="op">=</span><span class="va">True</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-10" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-10">Initialize variables: <span class="math inline">\(a = 0.18\)</span>, <span class="math inline">\(b = 0.8\)</span>, <span class="math inline">\(c = -0.1\)</span>, <span class="math inline">\(d = -0.4\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2" data-code-annotation="2" data-code-cell="annotated-cell-10">Set the learning rate to 0.1</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="4,5,6,7,8,9,10" data-code-annotation="3" data-code-cell="annotated-cell-10">Optimize the objective <span class="math inline">\(O_1\)</span> using the <code>standard gradient descent</code> method with learning rate 0.1, maximal iterations 80 and a tolerance of 1e-10</span>
</dd>
</dl>
</div>
</div>
<p>Looking at the printout (obtained with <code>silent=False</code> instead of <code>silent=True</code>), we see that convergence is achieved after 46 steps. We note that specifically convergence slows down significantly after 5 steps, as the gradients (and thus step sizes) become smaller the closer we get to the minima. This is the problem DIIS solves.</p>
<p>Let’s try again with acceleration.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:12.788696Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:12.769939Z&quot;}" data-execution_count="61">
<div class="sourceCode cell-code" id="annotated-cell-11"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="1">1</button><span id="annotated-cell-11-1" class="code-annotation-target"><a href="#annotated-cell-11-1" aria-hidden="true" tabindex="-1"></a>diis_result<span class="op">=</span>tq.minimize(objective<span class="op">=</span>O1,</span>
<span id="annotated-cell-11-2"><a href="#annotated-cell-11-2" aria-hidden="true" tabindex="-1"></a>                        lr<span class="op">=</span>lr,</span>
<span id="annotated-cell-11-3"><a href="#annotated-cell-11-3" aria-hidden="true" tabindex="-1"></a>                        method<span class="op">=</span><span class="st">'sgd'</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="2">2</button><span id="annotated-cell-11-4" class="code-annotation-target"><a href="#annotated-cell-11-4" aria-hidden="true" tabindex="-1"></a>                        diis<span class="op">=</span>{<span class="st">'tol'</span>:<span class="fl">1e-1</span>},</span>
<span id="annotated-cell-11-5"><a href="#annotated-cell-11-5" aria-hidden="true" tabindex="-1"></a>                        tol<span class="op">=</span><span class="fl">1e-10</span>,</span>
<span id="annotated-cell-11-6"><a href="#annotated-cell-11-6" aria-hidden="true" tabindex="-1"></a>                        maxiter<span class="op">=</span><span class="dv">80</span>,</span>
<span id="annotated-cell-11-7"><a href="#annotated-cell-11-7" aria-hidden="true" tabindex="-1"></a>                        initial_values<span class="op">=</span>init,</span>
<span id="annotated-cell-11-8"><a href="#annotated-cell-11-8" aria-hidden="true" tabindex="-1"></a>                        silent<span class="op">=</span><span class="va">True</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-11" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1,2,3,5,6,7,8" data-code-annotation="1" data-code-cell="annotated-cell-11">Optimize the objective <span class="math inline">\(O_1\)</span> using the <code>standard gradient descent</code> method with learning rate 0.1, maximal iterations 80, a tolerance of 1e-10 and DIIS acceleration</span>
</dd>
<dt data-target-cell="annotated-cell-11" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="4" data-code-annotation="2" data-code-cell="annotated-cell-11">Set the DIIS acceleration with a tolerance of 1e-10</span>
</dd>
</dl>
</div>
</div>
<p>With the printout here (change to <code>silent=False</code>), the convergence is obtained in just 8 steps. We can see here that DIIS kicks in at step 3, that is, when <span class="math inline">\(\texttt{max(gradient)}\)</span> is below <span class="math inline">\(\texttt{1e-1}\)</span> (the <code>tol=</code> argument in the DIIS dictionary) and we have accumulated at least 3 vectors. Once DIIS starts, convergence is very rapid, with a four orders of magnitude drop in the error within just three steps.</p>
<p>We can see this most clearly in a logarithmic plot of the error.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:12.875112Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:12.789725Z&quot;}" data-execution_count="62">
<div class="sourceCode cell-code" id="annotated-cell-12"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="1">1</button><span id="annotated-cell-12-1" class="code-annotation-target"><a href="#annotated-cell-12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy</span>
<span id="annotated-cell-12-2"><a href="#annotated-cell-12-2" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="annotated-cell-12-3"><a href="#annotated-cell-12-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'SGD + DIIS optimization results:'</span>)                                   </span>
<span id="annotated-cell-12-4"><a href="#annotated-cell-12-4" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="2">2</button><span id="annotated-cell-12-5" class="code-annotation-target"><a href="#annotated-cell-12-5" aria-hidden="true" tabindex="-1"></a>Emin <span class="op">=</span> diis_result.history.energies[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="annotated-cell-12-6"><a href="#annotated-cell-12-6" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="3">3</button><span id="annotated-cell-12-7" class="code-annotation-target"><a href="#annotated-cell-12-7" aria-hidden="true" tabindex="-1"></a>plt.semilogy(numpy.asarray(no_diis_result.history.energies[:<span class="op">-</span><span class="dv">1</span>]) <span class="op">-</span> Emin)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="4">4</button><span id="annotated-cell-12-8" class="code-annotation-target"><a href="#annotated-cell-12-8" aria-hidden="true" tabindex="-1"></a>plt.semilogy(numpy.asarray(diis_result.history.energies[:<span class="op">-</span><span class="dv">1</span>]) <span class="op">-</span> Emin)</span>
<span id="annotated-cell-12-9"><a href="#annotated-cell-12-9" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="5">5</button><span id="annotated-cell-12-10" class="code-annotation-target"><a href="#annotated-cell-12-10" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Error on energy'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="6">6</button><span id="annotated-cell-12-11" class="code-annotation-target"><a href="#annotated-cell-12-11" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">'without DIIS'</span>, <span class="st">'with DIIS'</span>])</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-12" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-12">Import the numpy library</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="5" data-code-annotation="2" data-code-cell="annotated-cell-12">Extract the last energy values from the DISS optimization</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="7" data-code-annotation="3" data-code-cell="annotated-cell-12">Plot the error on energy for every step in the optimization without DIIS acceleration</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="8" data-code-annotation="4" data-code-cell="annotated-cell-12">Plot the error on energy for every step in the optimization with DIIS acceleration</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="5">5</dt>
<dd>
<span data-code-lines="10" data-code-annotation="5" data-code-cell="annotated-cell-12">Label the y-axis of the plot as ‘Error on Energy’</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="6">6</dt>
<dd>
<span data-code-lines="11" data-code-annotation="6" data-code-cell="annotated-cell-12">Add a legend to the plot to differentiate between the results with and without DIIS</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>SGD + DIIS optimization results:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>&lt;matplotlib.legend.Legend at 0x16eabb100&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-13-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>We clearly see here that when DIIS kicks in, convergence rapidly accelerates. In comparison, the convergence rate of standard gradient descent actually slows down as we approach a solution. However, it should be noted that DIIS is not entirely stable and only really works close to an optima. Furthermore, the implementation here is somewhat experimental. Please use it at your own risk!</p>
<p><strong>The GD optimizer, with the Quantum Natural Gradient:</strong></p>
<p>The <code>Quantum Natural Gradient</code>, or QNG, is a novel method of calculating gradients for quantum systems, inspired by the natural gradient sometimes employed in classical machine learning. The usual gradient we employ is with respect to a Euclidean manifold, but this is not the only geometry – nor even the optimal geometry – of quantum space. The QNG is, in essence, a method of taking gradients with respect to (an approximation to) the Fubini-Study metric. For information on how (and why) the QNG is used, see <a href="https://arxiv.org/abs/1909.02108">Stokes et.al</a>.</p>
<p>Using the QNG in Tequila is as simple as passing in the keyword <code>gradient='qng'</code> to optimizers which support it, such as the GD optimizer. We will use it to optimize <span class="math inline">\(O_2\)</span>, our 3 qubit <code>Objective</code>, and then compare the results to optimizing the same circuit with the regular gradient.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:13.106790Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:12.876217Z&quot;}" data-execution_count="63">
<div class="sourceCode cell-code" id="annotated-cell-13"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="1">1</button><span id="annotated-cell-13-1" class="code-annotation-target"><a href="#annotated-cell-13-1" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="2">2</button><span id="annotated-cell-13-2" class="code-annotation-target"><a href="#annotated-cell-13-2" aria-hidden="true" tabindex="-1"></a>init<span class="op">=</span>{k:np.random.uniform(<span class="op">-</span><span class="dv">2</span>,<span class="dv">2</span>) <span class="cf">for</span> k <span class="kw">in</span> [<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>,<span class="st">'d'</span>]}</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="3">3</button><span id="annotated-cell-13-3" class="code-annotation-target"><a href="#annotated-cell-13-3" aria-hidden="true" tabindex="-1"></a>lr<span class="op">=</span><span class="fl">0.01</span></span>
<span id="annotated-cell-13-4"><a href="#annotated-cell-13-4" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="4">4</button><span id="annotated-cell-13-5" class="code-annotation-target"><a href="#annotated-cell-13-5" aria-hidden="true" tabindex="-1"></a>qng_result <span class="op">=</span> tq.minimize(objective<span class="op">=</span>O2,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="5">5</button><span id="annotated-cell-13-6" class="code-annotation-target"><a href="#annotated-cell-13-6" aria-hidden="true" tabindex="-1"></a>                         gradient<span class="op">=</span><span class="st">'qng'</span>,</span>
<span id="annotated-cell-13-7"><a href="#annotated-cell-13-7" aria-hidden="true" tabindex="-1"></a>                         method<span class="op">=</span><span class="st">'sgd'</span>,</span>
<span id="annotated-cell-13-8"><a href="#annotated-cell-13-8" aria-hidden="true" tabindex="-1"></a>                         maxiter<span class="op">=</span><span class="dv">200</span>,</span>
<span id="annotated-cell-13-9"><a href="#annotated-cell-13-9" aria-hidden="true" tabindex="-1"></a>                         lr<span class="op">=</span>lr,</span>
<span id="annotated-cell-13-10"><a href="#annotated-cell-13-10" aria-hidden="true" tabindex="-1"></a>                         initial_values<span class="op">=</span>init,</span>
<span id="annotated-cell-13-11"><a href="#annotated-cell-13-11" aria-hidden="true" tabindex="-1"></a>                         silent<span class="op">=</span><span class="va">True</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-13" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-13">keyword ‘stop_count’ stops optimization if no improvement occurs after 50 epochs</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2" data-code-annotation="2" data-code-cell="annotated-cell-13">Initialize the four variables to random values between -2 and 2</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="3" data-code-annotation="3" data-code-cell="annotated-cell-13">Set the learning rate to 0.01</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="5,7,8,9,10,11" data-code-annotation="4" data-code-cell="annotated-cell-13">Optimize the objective <span class="math inline">\(O_2\)</span> using the <code>standard gradient descent</code> method with learning rate 0.01, maximal iterations 200 and the Quantum Natural Gradient (QNG)</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="5">5</dt>
<dd>
<span data-code-lines="6" data-code-annotation="5" data-code-cell="annotated-cell-13">Set the gradient to the Quantum Natural Gradient (QNG)</span>
</dd>
</dl>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:13.221683Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:13.107532Z&quot;}" data-execution_count="64">
<div class="sourceCode cell-code" id="annotated-cell-14"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="1">1</button><span id="annotated-cell-14-1" class="code-annotation-target"><a href="#annotated-cell-14-1" aria-hidden="true" tabindex="-1"></a>qng_result.history.plot(<span class="st">'energies'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="2">2</button><span id="annotated-cell-14-2" class="code-annotation-target"><a href="#annotated-cell-14-2" aria-hidden="true" tabindex="-1"></a>qng_result.history.plot(<span class="st">'angles'</span>)</span>
<span id="annotated-cell-14-3"><a href="#annotated-cell-14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-4"><a href="#annotated-cell-14-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'best energy with qng: '</span>,qng_result.energy) </span>
<span id="annotated-cell-14-5"><a href="#annotated-cell-14-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'optimal angles with qng: '</span>,qng_result.angles)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-14" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-14">Plot the energy from the optimization with the Quantum Natural Gradient</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2" data-code-annotation="2" data-code-cell="annotated-cell-14">Plot the angles from the optimization with the Quantum Natural Gradient</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-15-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-15-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>best energy with qng:  -0.6121445376182162
optimal angles with qng:  a : -0.02215857873260148
b : 0.0059525380064374455
c : -0.014680638935248558
d : -0.0017630474321783914
</code></pre>
</div>
</div>
<p>To appreciate the benefits of using the QNG, let’s optimize the same circuit with the same learning rate and method, but without QNG.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:13.447491Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:13.225272Z&quot;}" data-execution_count="65">
<div class="sourceCode cell-code" id="annotated-cell-15"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="1">1</button><span id="annotated-cell-15-1" class="code-annotation-target"><a href="#annotated-cell-15-1" aria-hidden="true" tabindex="-1"></a>lr<span class="op">=</span><span class="fl">0.01</span></span>
<span id="annotated-cell-15-2"><a href="#annotated-cell-15-2" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="2">2</button><span id="annotated-cell-15-3" class="code-annotation-target"><a href="#annotated-cell-15-3" aria-hidden="true" tabindex="-1"></a>sgd_noqng_result <span class="op">=</span> tq.minimize(objective<span class="op">=</span>O2,</span>
<span id="annotated-cell-15-4"><a href="#annotated-cell-15-4" aria-hidden="true" tabindex="-1"></a>                               gradient<span class="op">=</span><span class="va">None</span>,</span>
<span id="annotated-cell-15-5"><a href="#annotated-cell-15-5" aria-hidden="true" tabindex="-1"></a>                               method<span class="op">=</span><span class="st">'sgd'</span>,</span>
<span id="annotated-cell-15-6"><a href="#annotated-cell-15-6" aria-hidden="true" tabindex="-1"></a>                               maxiter<span class="op">=</span><span class="dv">200</span>,</span>
<span id="annotated-cell-15-7"><a href="#annotated-cell-15-7" aria-hidden="true" tabindex="-1"></a>                               lr<span class="op">=</span>lr,</span>
<span id="annotated-cell-15-8"><a href="#annotated-cell-15-8" aria-hidden="true" tabindex="-1"></a>                               initial_values<span class="op">=</span>init,</span>
<span id="annotated-cell-15-9"><a href="#annotated-cell-15-9" aria-hidden="true" tabindex="-1"></a>                               silent<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-15-10"><a href="#annotated-cell-15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-15-11"><a href="#annotated-cell-15-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'plotting what happens without QNG'</span>)</span>
<span id="annotated-cell-15-12"><a href="#annotated-cell-15-12" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="3">3</button><span id="annotated-cell-15-13" class="code-annotation-target"><a href="#annotated-cell-15-13" aria-hidden="true" tabindex="-1"></a>sgd_noqng_result.history.plot(<span class="st">'energies'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="4">4</button><span id="annotated-cell-15-14" class="code-annotation-target"><a href="#annotated-cell-15-14" aria-hidden="true" tabindex="-1"></a>sgd_noqng_result.history.plot(<span class="st">'angles'</span>)</span>
<span id="annotated-cell-15-15"><a href="#annotated-cell-15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-15-16"><a href="#annotated-cell-15-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'best energy without qng: '</span>,sgd_noqng_result.energy)</span>
<span id="annotated-cell-15-17"><a href="#annotated-cell-15-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'optimal angles without qng: '</span>,sgd_noqng_result.angles)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-15" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-15">Set the learning rate to 0.01</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="3,4,5,6,7,8,9" data-code-annotation="2" data-code-cell="annotated-cell-15">Optimize the objective <span class="math inline">\(O_2\)</span> using the <code>standard gradient descent</code> method with learning rate 0.01 and maximal iterations 200</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="13" data-code-annotation="3" data-code-cell="annotated-cell-15">Plot the energy from the optimization without the Quantum Natural Gradient</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="14" data-code-annotation="4" data-code-cell="annotated-cell-15">Plot the angles from the optimization without the Quantum Natural Gradient</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>plotting what happens without QNG
best energy without qng:  -0.2591823908378972
optimal angles without qng:  a : -0.7272578239465537
b : 0.7880495712796224
c : -0.368377646698078
d : -0.8675949678046627
</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-16-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-16-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>Although the starting point was random, you will most likely see that the QNG run achieved a greater degree of improvement - it will not perform worse - and that the trajectories followed by the angles were different from those in the SGD-only optimization. Feel free to play around with other methods, learning rates, or circuits in your own code!</p>
</section>
<section id="the-scipy-optimizer" class="level2">
<h2 class="anchored" data-anchor-id="the-scipy-optimizer">The SciPy Optimizer</h2>
<p><code>SciPy</code> is one of the most popular optimization packages in <code>Python</code>. It offers a wide variety of optimization strategies. We will not cover them here; for a full exploration of all the <code>SciPy</code> methods, see <a href="https://docs.scipy.org/doc/scipy/reference/tutorial/optimize.html">their documentation</a>. Instead, we will showcase a few of the more powerful options available. Most <code>SciPy</code> keywords like <code>method_options</code>, can be passed directly to <code>minimize</code> in the same way as when using <code>SciPy</code> directly.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:13.451349Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:13.448924Z&quot;}" data-execution_count="66">
<div class="sourceCode cell-code" id="annotated-cell-16"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="1">1</button><span id="annotated-cell-16-1" class="code-annotation-target"><a href="#annotated-cell-16-1" aria-hidden="true" tabindex="-1"></a>tq.show_available_optimizers(module<span class="op">=</span><span class="st">"scipy"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-16" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-16">Get a list of all available optimization methods for the SciPy optimizer</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>available methods for optimizer module scipy
method               | optimizer module
--------------------------
NELDER-MEAD          | scipy
COBYLA               | scipy
POWELL               | scipy
SLSQP                | scipy
L-BFGS-B             | scipy
BFGS                 | scipy
CG                   | scipy
TNC                  | scipy
TRUST-KRYLOV         | scipy
NEWTON-CG            | scipy
DOGLEG               | scipy
TRUST-NCG            | scipy
TRUST-EXACT          | scipy
TRUST-CONSTR         | scipy</code></pre>
</div>
</div>
<p>We will try three different optimizers: <code>COBYLA</code>, which is gradient-free; <code>L-BFGS-B</code>, which employs gradients; and <code>NEWTON-CG</code>, which employs the Hessian.</p>
<p>Aa a reminder, we will optimize:</p>
<p><img src="O1.png" class="img-fluid" style="width:60.0%"></p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:13.648906Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:13.452148Z&quot;}" data-execution_count="67">
<div class="sourceCode cell-code" id="annotated-cell-17"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="1">1</button><span id="annotated-cell-17-1" class="code-annotation-target"><a href="#annotated-cell-17-1" aria-hidden="true" tabindex="-1"></a>init<span class="op">=</span>{<span class="st">'a'</span>:<span class="fl">0.25</span>,<span class="st">'b'</span>:<span class="fl">0.25</span>,<span class="st">'c'</span>:<span class="fl">0.25</span>,<span class="st">'d'</span>:<span class="fl">0.25</span>}</span>
<span id="annotated-cell-17-2"><a href="#annotated-cell-17-2" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="2">2</button><span id="annotated-cell-17-3" class="code-annotation-target"><a href="#annotated-cell-17-3" aria-hidden="true" tabindex="-1"></a>cobyla_result <span class="op">=</span> tq.minimize(objective<span class="op">=</span>O1,</span>
<span id="annotated-cell-17-4"><a href="#annotated-cell-17-4" aria-hidden="true" tabindex="-1"></a>                            method<span class="op">=</span><span class="st">"cobyla"</span>,</span>
<span id="annotated-cell-17-5"><a href="#annotated-cell-17-5" aria-hidden="true" tabindex="-1"></a>                            initial_values<span class="op">=</span>init,</span>
<span id="annotated-cell-17-6"><a href="#annotated-cell-17-6" aria-hidden="true" tabindex="-1"></a>                            tol<span class="op">=</span><span class="fl">1.e-3</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="3">3</button><span id="annotated-cell-17-7" class="code-annotation-target"><a href="#annotated-cell-17-7" aria-hidden="true" tabindex="-1"></a>                            method_options<span class="op">=</span>{<span class="st">"gtol"</span>:<span class="fl">1.e-3</span>},</span>
<span id="annotated-cell-17-8"><a href="#annotated-cell-17-8" aria-hidden="true" tabindex="-1"></a>                            silent<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-17-9"><a href="#annotated-cell-17-9" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="4">4</button><span id="annotated-cell-17-10" class="code-annotation-target"><a href="#annotated-cell-17-10" aria-hidden="true" tabindex="-1"></a>cobyla_result.history.plot(<span class="st">'energies'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="5">5</button><span id="annotated-cell-17-11" class="code-annotation-target"><a href="#annotated-cell-17-11" aria-hidden="true" tabindex="-1"></a>cobyla_result.history.plot(<span class="st">'angles'</span>)</span>
<span id="annotated-cell-17-12"><a href="#annotated-cell-17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-17-13"><a href="#annotated-cell-17-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'best energy with cobyla: '</span>,cobyla_result.energy)</span>
<span id="annotated-cell-17-14"><a href="#annotated-cell-17-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'optimal angles with cobyla: '</span>,cobyla_result.angles)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-17" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-17">Initialize all four variables to fixed values of <span class="math inline">\(0.25\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-17" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="3,4,5,6,8" data-code-annotation="2" data-code-cell="annotated-cell-17">Optimize the objective <span class="math inline">\(O_1\)</span> using the <code>COBYLA</code> method with a tolerance of <span class="math inline">\(1.e-3\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-17" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="7" data-code-annotation="3" data-code-cell="annotated-cell-17">Set the gradient tolerance to <span class="math inline">\(1.e-3\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-17" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="10" data-code-annotation="4" data-code-cell="annotated-cell-17">Plot the energy from the optimization with the COBYLA method</span>
</dd>
<dt data-target-cell="annotated-cell-17" data-target-annotation="5">5</dt>
<dd>
<span data-code-lines="11" data-code-annotation="5" data-code-cell="annotated-cell-17">Plot the angles from the optimization with the COBYLA method</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-18-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>best energy with cobyla:  -1.618031464593162
optimal angles with cobyla:  a : 2.147373632733447
b : 1.0010269344671066
c : -0.0014082403580806177
d : -0.5000442705117792
</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:13.844722Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:13.664490Z&quot;}" data-execution_count="68">
<div class="sourceCode cell-code" id="annotated-cell-18"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="1">1</button><span id="annotated-cell-18-1" class="code-annotation-target"><a href="#annotated-cell-18-1" aria-hidden="true" tabindex="-1"></a>lb_result <span class="op">=</span> tq.minimize(objective<span class="op">=</span>O1,</span>
<span id="annotated-cell-18-2"><a href="#annotated-cell-18-2" aria-hidden="true" tabindex="-1"></a>                        method<span class="op">=</span><span class="st">"l-bfgs-b"</span>,</span>
<span id="annotated-cell-18-3"><a href="#annotated-cell-18-3" aria-hidden="true" tabindex="-1"></a>                        initial_values<span class="op">=</span>init,</span>
<span id="annotated-cell-18-4"><a href="#annotated-cell-18-4" aria-hidden="true" tabindex="-1"></a>                        tol<span class="op">=</span><span class="fl">1.e-3</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="2">2</button><span id="annotated-cell-18-5" class="code-annotation-target"><a href="#annotated-cell-18-5" aria-hidden="true" tabindex="-1"></a>                        method_options<span class="op">=</span>{<span class="st">"gtol"</span>:<span class="fl">1.e-3</span>},</span>
<span id="annotated-cell-18-6"><a href="#annotated-cell-18-6" aria-hidden="true" tabindex="-1"></a>                        silent<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-18-7"><a href="#annotated-cell-18-7" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="3">3</button><span id="annotated-cell-18-8" class="code-annotation-target"><a href="#annotated-cell-18-8" aria-hidden="true" tabindex="-1"></a>lb_result.history.plot(<span class="st">'energies'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="4">4</button><span id="annotated-cell-18-9" class="code-annotation-target"><a href="#annotated-cell-18-9" aria-hidden="true" tabindex="-1"></a>lb_result.history.plot(<span class="st">'angles'</span>)</span>
<span id="annotated-cell-18-10"><a href="#annotated-cell-18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-18-11"><a href="#annotated-cell-18-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'best energy with L-BFGS-B: '</span>,lb_result.energy)</span>
<span id="annotated-cell-18-12"><a href="#annotated-cell-18-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'optimal angles with L-BFGS-B: '</span>,lb_result.angles)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-18" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1,2,3,4,6" data-code-annotation="1" data-code-cell="annotated-cell-18">Optimize the objective <span class="math inline">\(O_1\)</span> using the <code>L-BFGS-B</code> method with a tolerance of <span class="math inline">\(1.e-3\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="5" data-code-annotation="2" data-code-cell="annotated-cell-18">Set the gradient tolerance to <span class="math inline">\(1.e-3\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="8" data-code-annotation="3" data-code-cell="annotated-cell-18">Plot the energy from the optimization with the L-BFGS-B method</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="9" data-code-annotation="4" data-code-cell="annotated-cell-18">Plot the angles from the optimization with the L-BFGS-B method</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-19-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>best energy with L-BFGS-B:  -1.6178070274606597
optimal angles with L-BFGS-B:  a : 0.14354397455393397
b : 1.0061132343244423
c : -0.008256863017895754
d : -0.5036909456037741
</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:14.130953Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:13.846559Z&quot;}" data-execution_count="69">
<div class="sourceCode cell-code" id="annotated-cell-19"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="1">1</button><span id="annotated-cell-19-1" class="code-annotation-target"><a href="#annotated-cell-19-1" aria-hidden="true" tabindex="-1"></a>newton_result <span class="op">=</span> tq.minimize(objective<span class="op">=</span>O1,</span>
<span id="annotated-cell-19-2"><a href="#annotated-cell-19-2" aria-hidden="true" tabindex="-1"></a>                            method<span class="op">=</span><span class="st">"newton-cg"</span>,</span>
<span id="annotated-cell-19-3"><a href="#annotated-cell-19-3" aria-hidden="true" tabindex="-1"></a>                            initial_values<span class="op">=</span>init,</span>
<span id="annotated-cell-19-4"><a href="#annotated-cell-19-4" aria-hidden="true" tabindex="-1"></a>                            tol<span class="op">=</span><span class="fl">1.e-3</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="2">2</button><span id="annotated-cell-19-5" class="code-annotation-target"><a href="#annotated-cell-19-5" aria-hidden="true" tabindex="-1"></a>                            method_options<span class="op">=</span>{<span class="st">"gtol"</span>:<span class="fl">1.e-3</span>},</span>
<span id="annotated-cell-19-6"><a href="#annotated-cell-19-6" aria-hidden="true" tabindex="-1"></a>                            silent<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-19-7"><a href="#annotated-cell-19-7" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="3">3</button><span id="annotated-cell-19-8" class="code-annotation-target"><a href="#annotated-cell-19-8" aria-hidden="true" tabindex="-1"></a>newton_result.history.plot(<span class="st">'energies'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="4">4</button><span id="annotated-cell-19-9" class="code-annotation-target"><a href="#annotated-cell-19-9" aria-hidden="true" tabindex="-1"></a>newton_result.history.plot(<span class="st">'angles'</span>)</span>
<span id="annotated-cell-19-10"><a href="#annotated-cell-19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-19-11"><a href="#annotated-cell-19-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'best energy with NEWTON-CG: '</span>,newton_result.energy)</span>
<span id="annotated-cell-19-12"><a href="#annotated-cell-19-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'optimal angles with NEWTON-CG: '</span>,newton_result.angles)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-19" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1,2,3,4,6" data-code-annotation="1" data-code-cell="annotated-cell-19">Optimize the objective <span class="math inline">\(O_1\)</span> using the <code>NEWTON-CG</code> method with a tolerance of <span class="math inline">\(1.e-3\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="5" data-code-annotation="2" data-code-cell="annotated-cell-19">Set the gradient tolerance to <span class="math inline">\(1.e-3\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="8" data-code-annotation="3" data-code-cell="annotated-cell-19">Plot the energy from the optimization with the NEWTON-CG method</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="9" data-code-annotation="4" data-code-cell="annotated-cell-19">Plot the angles from the optimization with the NEWTON-CG method</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-20-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-20-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>best energy with NEWTON-CG:  -1.618032396266234
optimal angles with NEWTON-CG:  a : 0.1475346588846646
b : 1.000870829234684
c : -0.0011056953828126209
d : -0.49984554761229166
</code></pre>
</div>
</div>
<p>All three of the methods converged to the same minimum, but not necessarily to the same angles; the gradient and Hessian based methods converged to approximately the same angles in similar time.</p>
<p><strong>Scipy Extras: numerical gradients and Hessians</strong></p>
<p>Scipy allows for the use of numerical gradients. To use them, pass down keywords to the <code>gradient</code> argument, such as <code>'2-point'</code>. When using the numerical gradients of <code>SciPy</code>, it is often crucial to determine a feasible step size for the procedure. This can be done with the <code>method_options</code> entry <code>finite_diff_rel_step</code> (for <code>SciPy</code> version 1.5 or higher) or <code>eps</code> (for <code>SciPy</code> version &lt; 1.5).</p>
<p>Here is one example. <strong>Please ensure to check your SciPy version!</strong></p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:14.276979Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:14.132114Z&quot;}" data-execution_count="70">
<div class="sourceCode cell-code" id="annotated-cell-20"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="1">1</button><span id="annotated-cell-20-1" class="code-annotation-target"><a href="#annotated-cell-20-1" aria-hidden="true" tabindex="-1"></a>lb_result <span class="op">=</span> tq.minimize(objective<span class="op">=</span>O1,</span>
<span id="annotated-cell-20-2"><a href="#annotated-cell-20-2" aria-hidden="true" tabindex="-1"></a>                        method<span class="op">=</span><span class="st">"l-bfgs-b"</span>,</span>
<span id="annotated-cell-20-3"><a href="#annotated-cell-20-3" aria-hidden="true" tabindex="-1"></a>                        initial_values<span class="op">=</span>init,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="2">2</button><span id="annotated-cell-20-4" class="code-annotation-target"><a href="#annotated-cell-20-4" aria-hidden="true" tabindex="-1"></a>                        gradient<span class="op">=</span><span class="st">"2-point"</span>,</span>
<span id="annotated-cell-20-5"><a href="#annotated-cell-20-5" aria-hidden="true" tabindex="-1"></a>                        tol<span class="op">=</span><span class="fl">1.e-3</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="3">3</button><span id="annotated-cell-20-6" class="code-annotation-target"><a href="#annotated-cell-20-6" aria-hidden="true" tabindex="-1"></a>                        method_options<span class="op">=</span>{<span class="st">"gtol"</span>:<span class="fl">1.e-3</span>, <span class="st">"finite_diff_rel_step"</span>:<span class="fl">1.e-4</span>},</span>
<span id="annotated-cell-20-7"><a href="#annotated-cell-20-7" aria-hidden="true" tabindex="-1"></a>                        silent<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-20-8"><a href="#annotated-cell-20-8" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="4">4</button><span id="annotated-cell-20-9" class="code-annotation-target"><a href="#annotated-cell-20-9" aria-hidden="true" tabindex="-1"></a>lb_result.history.plot(<span class="st">'energies'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="5">5</button><span id="annotated-cell-20-10" class="code-annotation-target"><a href="#annotated-cell-20-10" aria-hidden="true" tabindex="-1"></a>lb_result.history.plot(<span class="st">'angles'</span>)</span>
<span id="annotated-cell-20-11"><a href="#annotated-cell-20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-20-12"><a href="#annotated-cell-20-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'best energy with L-BFGS-B: '</span>,lb_result.energy)</span>
<span id="annotated-cell-20-13"><a href="#annotated-cell-20-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'optimal angles with L-BFGS-B: '</span>,lb_result.angles)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-20" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1,2,3,5,7" data-code-annotation="1" data-code-cell="annotated-cell-20">Optimize the objective <span class="math inline">\(O_1\)</span> using the <code>L-BFGS-B</code> method with a tolerance of <span class="math inline">\(1.e-3\)</span>, numerical gradients, and a step size of <span class="math inline">\(1.e-4\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="4" data-code-annotation="2" data-code-cell="annotated-cell-20">Set the gradient to <code>2-point</code> to use numerical gradients</span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="6" data-code-annotation="3" data-code-cell="annotated-cell-20">Set the step size to <span class="math inline">\(1.e-4\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="9" data-code-annotation="4" data-code-cell="annotated-cell-20">Plot the energy from the optimization with the L-BFGS-B method and numerical gradients</span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="5">5</dt>
<dd>
<span data-code-lines="10" data-code-annotation="5" data-code-cell="annotated-cell-20">Plot the angles from the optimization with the L-BFGS-B method and numerical gradients</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-21-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-21-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>best energy with L-BFGS-B:  -1.6178082631717572
optimal angles with L-BFGS-B:  a : 0.1435263676387571
b : 1.0060019972486893
c : -0.00817836792105437
d : -0.5036839801675221
</code></pre>
</div>
</div>
<p><strong>Scipy Extras: the QNG in SciPy</strong></p>
<p>Scipy is also configured to use the QNG, just as the GD optimizer is. All one needs to do is set <code>gradient=qng</code>. Let’s see how QNG interacts with the <code>BFGS</code> optimizer. We will use <span class="math inline">\(0_2\)</span>, our 3-qubit expectation value, that we used previously.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:14.445114Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:14.278104Z&quot;}" data-execution_count="71">
<div class="sourceCode cell-code" id="annotated-cell-21"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="1">1</button><span id="annotated-cell-21-1" class="code-annotation-target"><a href="#annotated-cell-21-1" aria-hidden="true" tabindex="-1"></a>init<span class="op">=</span>{k:np.random.uniform(<span class="op">-</span><span class="dv">2</span>,<span class="dv">2</span>) <span class="cf">for</span> k <span class="kw">in</span> [<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>,<span class="st">'d'</span>]}</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="2">2</button><span id="annotated-cell-21-2" class="code-annotation-target"><a href="#annotated-cell-21-2" aria-hidden="true" tabindex="-1"></a>lr<span class="op">=</span><span class="fl">0.01</span></span>
<span id="annotated-cell-21-3"><a href="#annotated-cell-21-3" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="3">3</button><span id="annotated-cell-21-4" class="code-annotation-target"><a href="#annotated-cell-21-4" aria-hidden="true" tabindex="-1"></a>bfgs_qng_result <span class="op">=</span> tq.minimize(objective<span class="op">=</span>O2,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="4">4</button><span id="annotated-cell-21-5" class="code-annotation-target"><a href="#annotated-cell-21-5" aria-hidden="true" tabindex="-1"></a>                              gradient<span class="op">=</span><span class="st">'qng'</span>,</span>
<span id="annotated-cell-21-6"><a href="#annotated-cell-21-6" aria-hidden="true" tabindex="-1"></a>                              method<span class="op">=</span><span class="st">'bfgs'</span>,</span>
<span id="annotated-cell-21-7"><a href="#annotated-cell-21-7" aria-hidden="true" tabindex="-1"></a>                              maxiter<span class="op">=</span><span class="dv">200</span>,</span>
<span id="annotated-cell-21-8"><a href="#annotated-cell-21-8" aria-hidden="true" tabindex="-1"></a>                              lr<span class="op">=</span>lr,</span>
<span id="annotated-cell-21-9"><a href="#annotated-cell-21-9" aria-hidden="true" tabindex="-1"></a>                              initial_values<span class="op">=</span>init,</span>
<span id="annotated-cell-21-10"><a href="#annotated-cell-21-10" aria-hidden="true" tabindex="-1"></a>                              silent<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-21-11"><a href="#annotated-cell-21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-21-12"><a href="#annotated-cell-21-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'plotting what happens with QNG'</span>)</span>
<span id="annotated-cell-21-13"><a href="#annotated-cell-21-13" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="5">5</button><span id="annotated-cell-21-14" class="code-annotation-target"><a href="#annotated-cell-21-14" aria-hidden="true" tabindex="-1"></a>bfgs_qng_result.history.plot(<span class="st">'energies'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="6">6</button><span id="annotated-cell-21-15" class="code-annotation-target"><a href="#annotated-cell-21-15" aria-hidden="true" tabindex="-1"></a>bfgs_qng_result.history.plot(<span class="st">'angles'</span>)</span>
<span id="annotated-cell-21-16"><a href="#annotated-cell-21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-21-17"><a href="#annotated-cell-21-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'best energy with qng: '</span>,bfgs_qng_result.energy)</span>
<span id="annotated-cell-21-18"><a href="#annotated-cell-21-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'optimal angles with qng: '</span>,bfgs_qng_result.angles)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-21" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-21">Initialize the four variables to random values between -2 and 2</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2" data-code-annotation="2" data-code-cell="annotated-cell-21">Set the learning rate to 0.01</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="4,6,7,8,9,10" data-code-annotation="3" data-code-cell="annotated-cell-21">Optimize the objective <span class="math inline">\(O_2\)</span> using the <code>BFGS</code> method with learning rate 0.01, maximal iterations 200 and the Quantum Natural Gradient (QNG)</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="5" data-code-annotation="4" data-code-cell="annotated-cell-21">Set the gradient to the Quantum Natural Gradient (QNG)</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="5">5</dt>
<dd>
<span data-code-lines="14" data-code-annotation="5" data-code-cell="annotated-cell-21">Plot the energy from the optimization with the BFGS method and the Quantum Natural Gradient</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="6">6</dt>
<dd>
<span data-code-lines="15" data-code-annotation="6" data-code-cell="annotated-cell-21">Plot the angles from the optimization with the BFGS method and the Quantum Natural Gradient</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>plotting what happens with QNG
best energy with qng:  -0.3535533560030429
optimal angles with qng:  a : -1.57098151004744
b : 0.02566573196727211
c : 1.5704174098342945
d : 1.5706630278472251
</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-22-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-22-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:14.651676Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:14.446463Z&quot;}" data-execution_count="72">
<div class="sourceCode cell-code" id="annotated-cell-22"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="1">1</button><span id="annotated-cell-22-1" class="code-annotation-target"><a href="#annotated-cell-22-1" aria-hidden="true" tabindex="-1"></a>bfgs_noqng_result <span class="op">=</span> tq.minimize(objective<span class="op">=</span>O2,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="2">2</button><span id="annotated-cell-22-2" class="code-annotation-target"><a href="#annotated-cell-22-2" aria-hidden="true" tabindex="-1"></a>                                gradient<span class="op">=</span><span class="va">None</span>,</span>
<span id="annotated-cell-22-3"><a href="#annotated-cell-22-3" aria-hidden="true" tabindex="-1"></a>                                method<span class="op">=</span><span class="st">'bfgs'</span>,</span>
<span id="annotated-cell-22-4"><a href="#annotated-cell-22-4" aria-hidden="true" tabindex="-1"></a>                                maxiter<span class="op">=</span><span class="dv">200</span>,</span>
<span id="annotated-cell-22-5"><a href="#annotated-cell-22-5" aria-hidden="true" tabindex="-1"></a>                                lr<span class="op">=</span>lr,</span>
<span id="annotated-cell-22-6"><a href="#annotated-cell-22-6" aria-hidden="true" tabindex="-1"></a>                                initial_values<span class="op">=</span>init,</span>
<span id="annotated-cell-22-7"><a href="#annotated-cell-22-7" aria-hidden="true" tabindex="-1"></a>                                silent<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-22-8"><a href="#annotated-cell-22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-22-9"><a href="#annotated-cell-22-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'plotting what happens without QNG'</span>)</span>
<span id="annotated-cell-22-10"><a href="#annotated-cell-22-10" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="3">3</button><span id="annotated-cell-22-11" class="code-annotation-target"><a href="#annotated-cell-22-11" aria-hidden="true" tabindex="-1"></a>bfgs_noqng_result.history.plot(<span class="st">'energies'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="4">4</button><span id="annotated-cell-22-12" class="code-annotation-target"><a href="#annotated-cell-22-12" aria-hidden="true" tabindex="-1"></a>bfgs_noqng_result.history.plot(<span class="st">'angles'</span>)</span>
<span id="annotated-cell-22-13"><a href="#annotated-cell-22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-22-14"><a href="#annotated-cell-22-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'best energy without qng: '</span>,bfgs_noqng_result.energy)</span>
<span id="annotated-cell-22-15"><a href="#annotated-cell-22-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'optimal angles without qng: '</span>,bfgs_noqng_result.angles)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-22" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1,3,4,5,6,7" data-code-annotation="1" data-code-cell="annotated-cell-22">Optimize the objective <span class="math inline">\(O_2\)</span> using the <code>BFGS</code> method with learning rate 0.01 and maximal iterations 200</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="2" data-code-annotation="2" data-code-cell="annotated-cell-22">Set the gradient to None</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="11" data-code-annotation="3" data-code-cell="annotated-cell-22">Plot the energy from the optimization with the BFGS method</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="12" data-code-annotation="4" data-code-cell="annotated-cell-22">Plot the angles from the optimization with the BFGS method</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>plotting what happens without QNG
best energy without qng:  -0.6123722316299733
optimal angles without qng:  a : 0.00023318809750098347
b : -0.0007233623236951418
c : 5.297705957416901e-05
d : -0.00029333277886757145
</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-23-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-23-output-3.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="numerical-and-customized-gradients" class="level1">
<h1>Numerical and Customized Gradients</h1>
<p>By default <code>Tequila</code> compiles analytical gradients of the objectives using <code>jax</code>, internal recompilation, and the parameter shift rule. The default setting is not to set the <code>gradient</code> keyword or to set it to <code>None</code>. The keyword can also be set to a dictionary, where keys are the variables and values are the <code>Tequila</code>objectives assumed to evaluate to the corresponding gradients of the objective. For example, <code>gradient=tq.grad(objective)</code> will result in the same behavior as <code>gradient=None</code> or simply not setting it.</p>
<p><code>Tequila</code> offers its own way of compiling numerical gradients, which can then be used troughout all gradient-based optimizers. This can be activated by setting <code>gradient</code> to a dictionary holding the finite difference stencil as the <code>method</code>, as well as the <code>stepsize</code>.</p>
<p>Numerical gradients of this type come with the cost of <span class="math inline">\(2 \cdot\)</span> <code>len(variables)</code> and can lead to significantly cheaper gradients, especially if many expectation values are involved in the objective and/or if heavy recompilation of parametrized gates is necessary. Here is a small example using our <span class="math inline">\(O_2\)</span> objective. Here, the numerical 2-point procedure leads to 4 expectation values in the gradients (while analytical gradients would lead to 8). You can set <code>silent</code> to <code>False</code> in the upper example or remove the <code>gradient</code> statement here for comparison.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:14.775008Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:14.653207Z&quot;}" data-execution_count="73">
<div class="sourceCode cell-code" id="annotated-cell-23"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="1">1</button><span id="annotated-cell-23-1" class="code-annotation-target"><a href="#annotated-cell-23-1" aria-hidden="true" tabindex="-1"></a>lr<span class="op">=</span><span class="fl">0.01</span></span>
<span id="annotated-cell-23-2"><a href="#annotated-cell-23-2" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="2">2</button><span id="annotated-cell-23-3" class="code-annotation-target"><a href="#annotated-cell-23-3" aria-hidden="true" tabindex="-1"></a>num_result <span class="op">=</span> tq.minimize(objective<span class="op">=</span>O2,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="3">3</button><span id="annotated-cell-23-4" class="code-annotation-target"><a href="#annotated-cell-23-4" aria-hidden="true" tabindex="-1"></a>                        gradient<span class="op">=</span>{<span class="st">"method"</span>:<span class="st">"2-point"</span>, <span class="st">"stepsize"</span>:<span class="fl">1.e-4</span>},</span>
<span id="annotated-cell-23-5"><a href="#annotated-cell-23-5" aria-hidden="true" tabindex="-1"></a>                        method<span class="op">=</span><span class="st">'sgd'</span>,</span>
<span id="annotated-cell-23-6"><a href="#annotated-cell-23-6" aria-hidden="true" tabindex="-1"></a>                        maxiter<span class="op">=</span><span class="dv">200</span>,</span>
<span id="annotated-cell-23-7"><a href="#annotated-cell-23-7" aria-hidden="true" tabindex="-1"></a>                        lr<span class="op">=</span>lr,</span>
<span id="annotated-cell-23-8"><a href="#annotated-cell-23-8" aria-hidden="true" tabindex="-1"></a>                        initial_values<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="annotated-cell-23-9"><a href="#annotated-cell-23-9" aria-hidden="true" tabindex="-1"></a>                        silent<span class="op">=</span><span class="va">True</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-23" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-23">Set the learning rate to 0.01</span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="3,5,6,7,8,9" data-code-annotation="2" data-code-cell="annotated-cell-23">Optimize the objective <span class="math inline">\(O_2\)</span> using the <code>standard gradient descent</code> method with learning rate 0.01, maximal iterations 200 and numerical gradients with a step size of <span class="math inline">\(1.e-4\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="4" data-code-annotation="3" data-code-cell="annotated-cell-23">Set the gradient to a dictionary with the method <code>2-point</code> for numerical gradients and a step size of $1.e-4</span>
</dd>
</dl>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:14.830883Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:14.775603Z&quot;}" data-execution_count="74">
<div class="sourceCode cell-code" id="annotated-cell-24"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="1">1</button><span id="annotated-cell-24-1" class="code-annotation-target"><a href="#annotated-cell-24-1" aria-hidden="true" tabindex="-1"></a>num_result.history.plot(<span class="st">'energies'</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-24" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-24">Plot the energy from the ‘standard gradient descent’ optimization with numerical gradients</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-25-output-1.png" class="img-fluid"></p>
</div>
</div>
<p><code>Tequila</code> currently offers <code>2-point</code>, <code>2-point-forward</code> and <code>2-point-backward</code> stencils as <code>method</code>. The method can also be set to a Python function performing the task. Here is an example that implements the same functionality as <code>2-point</code>. The function can be replaced by any function with the same signature.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-07-19T13:02:15.005224Z&quot;,&quot;start_time&quot;:&quot;2024-07-19T13:02:14.831858Z&quot;}" data-execution_count="75">
<div class="sourceCode cell-code" id="annotated-cell-25"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="1">1</button><span id="annotated-cell-25-1" class="code-annotation-target"><a href="#annotated-cell-25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> copy</span>
<span id="annotated-cell-25-2"><a href="#annotated-cell-25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-25-3"><a href="#annotated-cell-25-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_finite_difference_stencil(obj, var_vals, key, step, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="annotated-cell-25-4"><a href="#annotated-cell-25-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="annotated-cell-25-5"><a href="#annotated-cell-25-5" aria-hidden="true" tabindex="-1"></a><span class="co">        calculate objective gradient by symmetric shifts about a point.</span></span>
<span id="annotated-cell-25-6"><a href="#annotated-cell-25-6" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters</span></span>
<span id="annotated-cell-25-7"><a href="#annotated-cell-25-7" aria-hidden="true" tabindex="-1"></a><span class="co">        ----------</span></span>
<span id="annotated-cell-25-8"><a href="#annotated-cell-25-8" aria-hidden="true" tabindex="-1"></a><span class="co">        obj: Objective:</span></span>
<span id="annotated-cell-25-9"><a href="#annotated-cell-25-9" aria-hidden="true" tabindex="-1"></a><span class="co">            objective to call.</span></span>
<span id="annotated-cell-25-10"><a href="#annotated-cell-25-10" aria-hidden="true" tabindex="-1"></a><span class="co">        var_vals:</span></span>
<span id="annotated-cell-25-11"><a href="#annotated-cell-25-11" aria-hidden="true" tabindex="-1"></a><span class="co">            variables to feed to the objective.</span></span>
<span id="annotated-cell-25-12"><a href="#annotated-cell-25-12" aria-hidden="true" tabindex="-1"></a><span class="co">        key:</span></span>
<span id="annotated-cell-25-13"><a href="#annotated-cell-25-13" aria-hidden="true" tabindex="-1"></a><span class="co">            which variable to shift, i.e, which variable's gradient is being called.</span></span>
<span id="annotated-cell-25-14"><a href="#annotated-cell-25-14" aria-hidden="true" tabindex="-1"></a><span class="co">        step:</span></span>
<span id="annotated-cell-25-15"><a href="#annotated-cell-25-15" aria-hidden="true" tabindex="-1"></a><span class="co">            the size of the shift; a small float.</span></span>
<span id="annotated-cell-25-16"><a href="#annotated-cell-25-16" aria-hidden="true" tabindex="-1"></a><span class="co">        args</span></span>
<span id="annotated-cell-25-17"><a href="#annotated-cell-25-17" aria-hidden="true" tabindex="-1"></a><span class="co">        kwargs</span></span>
<span id="annotated-cell-25-18"><a href="#annotated-cell-25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-25-19"><a href="#annotated-cell-25-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns</span></span>
<span id="annotated-cell-25-20"><a href="#annotated-cell-25-20" aria-hidden="true" tabindex="-1"></a><span class="co">        -------</span></span>
<span id="annotated-cell-25-21"><a href="#annotated-cell-25-21" aria-hidden="true" tabindex="-1"></a><span class="co">        float:</span></span>
<span id="annotated-cell-25-22"><a href="#annotated-cell-25-22" aria-hidden="true" tabindex="-1"></a><span class="co">            the approximated gradient of obj w.r.t variable key at point var_vals[key] as a float.</span></span>
<span id="annotated-cell-25-23"><a href="#annotated-cell-25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-25-24"><a href="#annotated-cell-25-24" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="2">2</button><span id="annotated-cell-25-25" class="code-annotation-target"><a href="#annotated-cell-25-25" aria-hidden="true" tabindex="-1"></a>        left <span class="op">=</span> copy.deepcopy(var_vals)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="3">3</button><span id="annotated-cell-25-26" class="code-annotation-target"><a href="#annotated-cell-25-26" aria-hidden="true" tabindex="-1"></a>        left[key] <span class="op">+=</span> step <span class="op">/</span> <span class="dv">2</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="4">4</button><span id="annotated-cell-25-27" class="code-annotation-target"><a href="#annotated-cell-25-27" aria-hidden="true" tabindex="-1"></a>        right <span class="op">=</span> copy.deepcopy(var_vals)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="5">5</button><span id="annotated-cell-25-28" class="code-annotation-target"><a href="#annotated-cell-25-28" aria-hidden="true" tabindex="-1"></a>        right[key] <span class="op">-=</span> step <span class="op">/</span> <span class="dv">2</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="6">6</button><span id="annotated-cell-25-29" class="code-annotation-target"><a href="#annotated-cell-25-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="op">/</span> step <span class="op">*</span> (obj(left, <span class="op">*</span>args, <span class="op">**</span>kwargs) <span class="op">-</span> obj(right, <span class="op">*</span>args, <span class="op">**</span>kwargs))</span>
<span id="annotated-cell-25-30"><a href="#annotated-cell-25-30" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="7">7</button><span id="annotated-cell-25-31" class="code-annotation-target"><a href="#annotated-cell-25-31" aria-hidden="true" tabindex="-1"></a>num_result <span class="op">=</span> tq.minimize(objective<span class="op">=</span>O2,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="8">8</button><span id="annotated-cell-25-32" class="code-annotation-target"><a href="#annotated-cell-25-32" aria-hidden="true" tabindex="-1"></a>                         gradient<span class="op">=</span>{<span class="st">"method"</span>:my_finite_difference_stencil, <span class="st">"stepsize"</span>:<span class="fl">1.e-4</span>},</span>
<span id="annotated-cell-25-33"><a href="#annotated-cell-25-33" aria-hidden="true" tabindex="-1"></a>                         method<span class="op">=</span><span class="st">'sgd'</span>,</span>
<span id="annotated-cell-25-34"><a href="#annotated-cell-25-34" aria-hidden="true" tabindex="-1"></a>                         maxiter<span class="op">=</span><span class="dv">200</span>,</span>
<span id="annotated-cell-25-35"><a href="#annotated-cell-25-35" aria-hidden="true" tabindex="-1"></a>                         lr<span class="op">=</span>lr,</span>
<span id="annotated-cell-25-36"><a href="#annotated-cell-25-36" aria-hidden="true" tabindex="-1"></a>                         initial_values<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="annotated-cell-25-37"><a href="#annotated-cell-25-37" aria-hidden="true" tabindex="-1"></a>                         silent<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-25-38"><a href="#annotated-cell-25-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-25-39"><a href="#annotated-cell-25-39" aria-hidden="true" tabindex="-1"></a>num_result.history.plot(<span class="st">'energies'</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-25" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-annotation="1" data-code-cell="annotated-cell-25">Import the copy library to deep copy objects</span>
</dd>
<dt data-target-cell="annotated-cell-25" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="25" data-code-annotation="2" data-code-cell="annotated-cell-25">Create a deep copy of the variable</span>
</dd>
<dt data-target-cell="annotated-cell-25" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="26" data-code-annotation="3" data-code-cell="annotated-cell-25">Shift the variable to the right by half of the step size</span>
</dd>
<dt data-target-cell="annotated-cell-25" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="27" data-code-annotation="4" data-code-cell="annotated-cell-25">Create another deep copy of the variable</span>
</dd>
<dt data-target-cell="annotated-cell-25" data-target-annotation="5">5</dt>
<dd>
<span data-code-lines="28" data-code-annotation="5" data-code-cell="annotated-cell-25">Shift the variable to the left by half of the step size</span>
</dd>
<dt data-target-cell="annotated-cell-25" data-target-annotation="6">6</dt>
<dd>
<span data-code-lines="29" data-code-annotation="6" data-code-cell="annotated-cell-25">Calculate the difference gradient using the symmetric difference quotient.</span>
</dd>
<dt data-target-cell="annotated-cell-25" data-target-annotation="7">7</dt>
<dd>
<span data-code-lines="31,33,34,35,36,37" data-code-annotation="7" data-code-cell="annotated-cell-25">Optimize the objective <span class="math inline">\(O_2\)</span> using the <code>standard gradient descent</code> method with learning rate 0.01, maximal iterations 200 and an objective gradient with a step size of <span class="math inline">\(1.e-4\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-25" data-target-annotation="8">8</dt>
<dd>
<span data-code-lines="32" data-code-annotation="8" data-code-cell="annotated-cell-25">Set the gradient to a dictionary with the method <code>my_finite_difference_stencil</code> and a step size of <span class="math inline">\(1.e-4\)</span></span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<p><img src="Optimizers_files/figure-html/cell-26-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The <code>gradient</code> keyword can also be replaced by a dictionary of <code>Tequila</code> objectives which evaluate to gradients approximations of it.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Handle positioning of the toggle
      window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="tequilahub/tequila-tutorials" issue-term="pathname" theme="preferred-color-scheme" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center"><div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>